# libeventäº†è§£
## ä»‹ç»
libeventæ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶å¤„ç†è½¯ä»¶å‡½æ•°åº“ã€‚libeventæ˜¯ä¸€ä¸ªæä¾›å¼‚æ­¥äº‹ä»¶é€šçŸ¥çš„è½¯ä»¶åº“ã€‚libeventæä¾›äº†ä¸€ç»„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰ï¼Œlibevent APIæä¾›çš„æœºåˆ¶å…è®¸å¼€å‘è€…ä¸ºäº‹ä»¶æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä¾‹å¦‚æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„å‘ç”Ÿäº†ç‰¹å®šäº‹ä»¶æˆ–è€…ç­‰å¾…ç‰¹å®šäº‹ä»¶è¶…æ—¶ï¼Œæ¥æ”¶åˆ°ä¿¡å·çš„äº‹ä»¶ï¼Œå¸¸è§„çš„å®šæ—¶å™¨è¶…æ—¶äº‹ä»¶ã€‚å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œlibeventå®ä¾‹ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ã€‚libevent åœ¨è®¾è®¡ä¸Šæ˜¯ç”¨æ¥æ›¿ä»£å¾ˆå¤šäº‹ä»¶é©±åŠ¨ç½‘ç»œæœåŠ¡å™¨è‡ªè¡Œå®ç°çš„äº‹ä»¶å¾ªç¯æ¡†æ¶çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œlibeventå¯ä»¥ç”¨æ¥å–ä»£ç½‘ç»œæœåŠ¡å™¨æ‰€ä½¿ç”¨çš„äº‹ä»¶å¾ªç¯æ£€æŸ¥æ¡†æ¶ã€‚

å¼€å‘è€…é€šè¿‡ libevent æ³¨å†Œä¿¡å·å›è°ƒï¼Œå¯ä»¥ç¼–å†™â€œå®‰å…¨â€çš„ä¿¡å·å¤„ç†ç¨‹åºï¼Œå› ä¸ºç”¨æˆ·æä¾›çš„ä¿¡å·å¤„ç†ç¨‹åºéƒ½ä¸ä¼šåœ¨ä¿¡å· å¤„ç†ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚

å¼€å‘è€…é€šè¿‡ libevent æ³¨å†Œä¿¡å·å›è°ƒï¼Œå¯ä»¥ç¼–å†™â€œå®‰å…¨â€çš„ä¿¡å·å¤„ç†ç¨‹åºï¼Œå› ä¸ºç”¨æˆ·æä¾›çš„ä¿¡å·å¤„ç†ç¨‹åºéƒ½ä¸ä¼šåœ¨ä¿¡å· å¤„ç†ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚

ç”±äºå¯ä»¥çœå»å¯¹ç½‘ç»œçš„å¤„ç†ï¼Œä¸”æ‹¥æœ‰ä¸é”™çš„æ€§èƒ½ï¼Œæœ‰äº›è½¯ä»¶ä½¿ç”¨libeventä½œä¸ºç½‘ç»œåº•å±‚çš„å‡½æ•°åº“ï¼Œå¦‚ï¼šmemcachedã€Torã€‚

## æ ¸å¿ƒæ•°æ®ç»“æ„

### event_base
- æ ¸å¿ƒï¼šäº‹ä»¶å¾ªç¯ï¼ˆreactorï¼‰

- å°è£…äº†åº•å±‚ IO å¤ç”¨æœºåˆ¶ï¼ˆepoll/kqueue/select/pollï¼‰ã€‚

- ç»´æŠ¤ä¸€ä¸ª äº‹ä»¶é˜Ÿåˆ—ï¼Œä¸æ–­ dispatch() æ£€æŸ¥å°±ç»ªçš„äº‹ä»¶å¹¶è°ƒç”¨å›è°ƒã€‚

- æ˜¯æ‰€æœ‰äº‹ä»¶ï¼ˆeventã€buffereventã€evconnlistenerï¼‰çš„â€œå®¹å™¨â€ï¼Œå®ƒä»¬å¿…é¡»ä¾é™„åœ¨æŸä¸ª event_base ä¸Šã€‚

ğŸ‘‰ å¯ä»¥ç†è§£ä¸º å¤§è„‘ï¼Œå…¶ä»–å¯¹è±¡éƒ½è¦æŒ‚åœ¨å®ƒä¸Šé¢ã€‚

### event
- æœ€åŸºç¡€çš„äº‹ä»¶å¯¹è±¡ã€‚

- ç»‘å®š (fd, äº‹ä»¶ç±»å‹, å›è°ƒå‡½æ•°)ã€‚

- ç±»å‹åŒ…æ‹¬ï¼š

    - IO äº‹ä»¶ï¼ˆEV_READã€EV_WRITEï¼‰

    - ä¿¡å·äº‹ä»¶

    - å®šæ—¶å™¨äº‹ä»¶

- buffereventã€evconnlistener çš„å†…éƒ¨ï¼Œéƒ½æ˜¯ç”¨ä¸€å † event æ¥å®ç°çš„ã€‚

ğŸ‘‰ å¯ä»¥ç†è§£ä¸º ç¥ç»æœ«æ¢¢ï¼Œç›´æ¥è´Ÿè´£å“åº”æŸä¸ª fd çš„äº‹ä»¶ã€‚

### bufferevent
- å°è£…äº†ä¸¤ä¸ª eventã€ç»‘å®šåŒä¸€ä¸ªfdã€‘ï¼š

    - ä¸€ä¸ªè´Ÿè´£ è¯»äº‹ä»¶ï¼ˆfd å¯è¯»ï¼‰

    - ä¸€ä¸ªè´Ÿè´£ å†™äº‹ä»¶ï¼ˆfd å¯å†™ï¼‰

- å†…éƒ¨æœ‰ä¸¤ä¸ª evbufferï¼š

    - è¾“å…¥ç¼“å†²åŒºï¼ˆå­˜æ”¾è¯»åˆ°çš„æ•°æ®ï¼‰

    - è¾“å‡ºç¼“å†²åŒºï¼ˆå­˜æ”¾è¦å†™çš„æ•°æ®ï¼‰

- æä¾›äº†æ›´é«˜çº§çš„æ¥å£ï¼š

    - bufferevent_setcbï¼ˆç»‘å®šè¯»/å†™/é”™è¯¯å›è°ƒï¼‰

    - bufferevent_read / bufferevent_write

è®©åº”ç”¨å±‚ä¸å¿…è‡ªå·±åå¤å¤„ç† read() / write() å’Œ EAGAIN é”™è¯¯ã€‚

ğŸ‘‰ å¯ä»¥ç†è§£ä¸º å¸¦ç¼“å­˜çš„ socket åŒ…è£…å™¨ã€‚
### evconnlistener

- å°è£…äº†ä¸€ä¸ª ç›‘å¬ socket + ä¸€ä¸ª eventã€‚

- ä¸“é—¨å¤„ç† accept()ï¼š## è°ƒç”¨listenåfdè¿›å…¥ç›‘å¬çŠ¶æ€ï¼Œç›‘å¬fdçš„å¯è¯»äº‹ä»¶å°±æ˜¯ç›‘å¬å¥—æ¥å­—ä¸Šæœ‰æ–°çš„è¿æ¥è¯·æ±‚ã€‚ å¯¹åº”libeventå®šä¹‰çš„æ–°è¿æ¥äº‹ä»¶

    - å½“ç›‘å¬ fd å¯è¯» â†’ è¯´æ˜æœ‰æ–°è¿æ¥ â†’ å†…éƒ¨è‡ªåŠ¨è°ƒç”¨ accept â†’ è§¦å‘ç”¨æˆ·å›è°ƒï¼ˆaccept_conn_cbï¼‰ã€‚

- å¸¸è§ç”¨æ³•ï¼ševconnlistener_new_bind()ã€‚

ğŸ‘‰ å¯ä»¥ç†è§£ä¸º æ–°è¿æ¥åˆ†å‘å™¨ï¼Œè‡ªåŠ¨å¸®ä½ æ¥æ–°è¿æ¥ï¼Œç„¶åäº¤ç»™åº”ç”¨ã€‚
### æ ¸å¿ƒç»“æ„å…³ç³»å›¾
```lua
                +-------------------+
                |    event_base     |   (äº‹ä»¶å¾ªç¯è°ƒåº¦ä¸­å¿ƒ)
                +---------+---------+
                        |
        +------------------+---------------------------+
        |                  |                           |
+-------v--------+   +-----v-----+              +------v------+
| evconnlistener |   |  event    |              | bufferevent |
|                |   | (å®šæ—¶å™¨ç­‰) |              |             |
| - listen_fd    |   +-----------+              | - read_event|
| - event        |                              | - write_event
| - accept_cb    |                              | - evbuffer  |
+----------------+                              +-------------+
        |
        | (accept æ–°è¿æ¥ï¼Œå›è°ƒè§¦å‘)
        v
åº”ç”¨å±‚ä»£ç å†³å®šå¦‚ä½•å¤„ç†ï¼š
--> ä¸€èˆ¬ä¼šåˆ›å»º bufferevent æ¥ç®¡ç†è¿™ä¸ªæ–°è¿æ¥

```

## æ•°æ®æµå›¾
- ä»¥ä¸‹æ—¶åºå›¾å±•ç¤ºäº†åŸºäºlibeventå®ç°çš„ä»£ç†åŠ å¯†ä¼ è¾“çš„æ•°æ®æµ:
å®¢æˆ·ç«¯å‘æ¶ˆæ¯ â†’ ä»£ç†è½¬å‘ â†’ æœåŠ¡ç«¯å¤„ç† â†’ æœåŠ¡ç«¯å›æ¶ˆæ¯ â†’ ä»£ç†è½¬å‘ â†’ å®¢æˆ·ç«¯æ”¶åˆ°ï¼Œæ•´ä¸ªè¿‡ç¨‹çš„é“¾è·¯ã€‚

```lua
å®¢æˆ·ç«¯                        ä»£ç† (proxy)                               æœåŠ¡ç«¯
   |                             |                                          |
   | 1. TCPè¿æ¥å»ºç«‹              |                                          |
   |---------------------------->| (evconnlisteneræ¥æ”¶è¿æ¥)                 |
   |                             | ç”Ÿæˆ clientBufferEvent   ç»‘å®šåˆ° client_fd |
   |                             | ç”Ÿæˆ serverBufferEvent                   |
   | 2. å‘é€æ•°æ®                  |ä»£ç†è¿æ¥æœåŠ¡ç«¯ å°†serverBufferEventç»‘å®šåˆ°server_fd |
   |---------------------------->|                                          |
   |                             | (event_baseæ£€æµ‹ client_fd å¯è¯»)           |
   |                             |--> clientReadCb                          |
   |                             |   [è¯»å–æ•°æ®, åŠ å¯†/å°åŒ…]                   |
   |                             |   bufferevent_write(serverBufferEvent)   |
   |                             |-----------------------> server_fd        |
   |                             |                                          |
   |                             | 3. è½¬å‘æ•°æ®                              |
   |                             | (serverBufferEventå†™ç¼“å†²â†’TCPå‘é€)         |
   |                             |----------------------------->            |
   |                             |                                          |
   |                             |                             4. æœåŠ¡ç«¯å¤„ç†|
   |                             |<-----------------------------            |
   |                             | (event_baseæ£€æµ‹ server_fd å¯è¯»)          |
   |                             |--> serverReadCb                          |
   |                             |   [è¯»å–æ•°æ®, è§£å¯†/è§£åŒ…]                   |
   |                             |   bufferevent_write(clientBufferEvent)   |
   |                             |-----------------------> client_fd        |
   |                             |                                          |
   | 5. å®¢æˆ·ç«¯æ”¶åˆ°å“åº”            |                                          |
   |<----------------------------|                                          |

```
**æµç¨‹è§£è¯»ï¼š**

1. å»ºç«‹è¿æ¥ï¼šå®¢æˆ·ç«¯è¿åˆ°ä»£ç†ï¼Œä»£ç†ç”¨ evconnlistener æ¥æ”¶ï¼Œç”Ÿæˆ clientBufferEventï¼Œå¹¶å»ºç«‹åˆ°æœåŠ¡ç«¯çš„ serverBufferEventã€‚

2. å®¢æˆ·ç«¯å‘æ•°æ®ï¼šclientReadCb è§¦å‘ â†’ åŠ å¯†/å°è£… â†’ å†™å…¥ serverBufferEvent â†’ å‘ç»™æœåŠ¡ç«¯ã€‚

3. æœåŠ¡ç«¯å¤„ç†å¹¶è¿”å›æ•°æ®ï¼šæ•°æ®åˆ°è¾¾ä»£ç† â†’ serverReadCb è§¦å‘ â†’ è§£å¯†/è§£åŒ… â†’ å†™å…¥ clientBufferEvent â†’ å‘å›å®¢æˆ·ç«¯ã€‚

4. å®¢æˆ·ç«¯æ”¶åˆ°å“åº”ï¼Œå®Œæˆä¸€æ¬¡åŒå‘æ•°æ®ä¼ è¾“ã€‚
