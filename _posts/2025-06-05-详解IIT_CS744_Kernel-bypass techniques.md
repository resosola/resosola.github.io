# 详解IIT_CS744_Kernel-bypass techniques
- 本篇文章主要是对IIT_CS744_Kernel-bypass techniques的学习笔记，主要是对kernel bypass的一些技术的学习，同时对课程文档进行详解。

- 这门课程主题是 **用于高速网络数据包处理的内核旁路技术（Kernel-bypass techniques）**。它系统地讲解了传统内核网络栈中的数据包处理流程、存在的性能瓶颈，以及如何通过“内核旁路”技术绕过这些瓶颈，最终提升网络处理能力，尤其在面对 40Gbps/100Gbps 的高速网卡时。

## 总体结构
- 这门课程主要分为以下几个部分：
    - 第一部分：数据包的传统传输路径
    - 第二部分：内核中的性能瓶颈
    - 第三部分：内核旁路技术
      - 用户态数据包处理（如 DPDK、Netmap）
      - 用户态网络协议栈（如 mTCP）
    - 第四部分：网络处理的新趋势（如 eBPF、XDP、可编程网卡）

## 第一部分：数据包在 Linux 网络栈中的旅程
- 在 Linux 中，数据包的发送和接收都需要经过操作系统内核的网络栈。这个流程可以分为两部分：
  - 接收路径（Receive Path）：网络设备 → 应用程序
  - 发送路径（Transmit Path）：应用程序 → 网络设备

### 接收路径
- 网络接口卡（NIC）接收到数据包
  - NIC 硬件接收队列（RX Queue） 中接收到一个数据包。
  - NIC 校验：
    - 检查 目标 MAC 地址
    - 验证 以太网帧校验序列（FCS）
  - NIC 通过 DMA（Direct Memory Access）将数据包 复制到 内核分配的内存区域（RX ring buffer）。
  - NIC 向 CPU 发出 中断请求：通知系统“我收到了一个包”。

- 中断处理（IRQ Handling）
  - Linux 把中断处理分成两个阶段：
    - Top-half（硬中断 HardIRQ） 快速处理，只做简单的事情。
    - Bottom-half（软中断 SoftIRQ） 复杂处理，稍后再执行
  - Top-half 处理：
    - CPU 通过 中断描述符表（IDT） 查找到对应的 ISR（中断服务例程）
    - ISR 只完成一些最基本的操作，例如：
      - 确认中断
      - 将后续处理任务排入 softirq 队列中
- Bottom-half（软中断 SoftIRQ）开始真正的处理
  - 系统空闲时，内核处理 softirq 中排队的任务。
  - 网卡驱动程序为每个接收到的数据包 动态分配 sk_buff（简称 skb）结构，这个结构包含：
    - 数据包元数据（头部指针、负载指针、校验和等）
    - 实际的包数据指针
  - 网络协议栈处理分层：
    - L2（链路层）处理：
      - 去掉以太网头部（Ethernet Header）
    - L3（网络层）处理：
      - 检查目标 IP 地址、校验和
      - 路由查找、IP 重组（fragment reassembly）
      - 调用下一层 L4（传输层）处理
    - L4（传输层）处理：处理 TCP/UDP 头部
      - TCP/UDP 协议处理
      - TCP 状态机、窗口机制等
      - 将 skb 添加到 socket 的接收队列（read queue）
- 应用读取数据
  - 当数据准备好后，内核会通过 epoll/select/poll 等机制 通知应用程序。
  - 应用调用 read() 系统调用 → 触发 用户态 → 内核态切换。
  - 内核将 skb 中的数据复制到应用缓冲区（用户态）。
  - 释放 skb 结构。

### 发送路径
- 应用发送数据
  - 应用调用 send() / sendmsg() / write() 等系统调用。
  - 系统调用 → 触发 用户态 → 内核态切换
  - 数据从用户缓冲区复制到内核缓冲区。
  - 内核为每个数据包创建一个 sk_buff 结构。
- 内核协议栈处理
  - L4（TCP/UDP）层：
    - 构造 TCP/UDP 头部
    - 加入 socket 的 写队列
  - L3（IP）层：
    - IP 分片（如果包太大）
    - 添加 IP 头部
  - L2（Ethernet）层：
    - 添加以太网头部（源 MAC、目标 MAC、类型）
    - 传给 QDisc（队列调度器）
- QDisc 调度器
  - QDisc 是 Linux 中实现流量控制和队列策略的组件。
  - 对数据包进行 排队、限速、优先级调度 等操作。
  - 如果网卡有空闲的 TX 缓冲区，则：
    - 将 skb 传递给网卡驱动
    - 启动 DMA，把数据拷贝到网卡硬件发送队列
- NIC 发送数据
  - NIC 计算 以太网帧校验和（FCS）。
  - 把包发送到物理线路（电缆或光纤）。
  - 通知内核“包已发送”，并释放 skb。

### 性能瓶颈分析
|  瓶颈类型   | 描述  |
|  ----  | ----  |
| Context switch  | 应用和内核之间频繁切换，耗费 CPU 时间 |
| Packet copy  | 内核 ↔ 用户态之间的数据复制 |
| Dynamic skb 分配  | 每个包都动态创建结构体，慢 |
| 中断处理开销  | 每个包都触发中断，增加负载 |
| 共享数据结构加锁  | socket 队列、TCP 状态等结构是共享的，多核争用严重 |
	
	
## 内核旁路（Kernel Bypass）技术的动机
- 由于上述瓶颈，在高性能网络（如 100Gbps）中，Linux 内核难以跑满“线速（line-rate）”。因此，需要在用户态直接处理数据包，以绕过内核网络协议栈，从而提升性能。

## 常见的内核旁路技术
